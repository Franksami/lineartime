name: ğŸ”’ Foundation Protection & Quality Assurance

on:
  pull_request:
    branches: [main]
  push:
    branches: [feature/*, develop]

jobs:
  foundation-protection:
    name: ğŸ”’ Foundation Protection Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'
          
      - name: ğŸ”§ Install Dependencies
        run: |
          npm install -g pnpm
          pnpm install
          
      - name: ğŸ”’ Foundation Structure Validation
        run: |
          echo "ğŸ§ª Testing foundation structure integrity..."
          npm run test:foundation
          
      - name: âš¡ Performance Benchmark Validation
        run: |
          echo "ğŸ“Š Validating performance benchmarks..."
          npx playwright test tests/foundation-validation.spec.ts --project=chromium --grep "performance"
          
      - name: ğŸ—ï¸ Build Validation
        run: |
          echo "ğŸ”¨ Testing production build..."
          npm run build
          
      - name: ğŸ§¹ Code Quality Check
        run: |
          echo "âœ¨ Running code quality validation..."
          npm run lint
          
      - name: ğŸ“± Cross-Platform Foundation Test
        run: |
          echo "ğŸ“± Testing foundation across devices..."
          npx playwright test tests/foundation-validation.spec.ts --project="Mobile Chrome" --grep "Cross-Platform"

  feature-validation:
    name: ğŸ§ª Feature Integration Tests
    runs-on: ubuntu-latest
    needs: foundation-protection
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'
          
      - name: ğŸ”§ Install Dependencies
        run: |
          npm install -g pnpm
          pnpm install
          
      - name: ğŸ¯ Event Management Reality Check
        run: |
          echo "ğŸ¯ Testing event management integration..."
          npx playwright test tests/event-management-reality.spec.ts --project=chromium
          
      - name: ğŸ¤– AI Features Validation
        run: |
          echo "ğŸ¤– Testing AI Assistant and CommandBar..."
          npx playwright test tests/event-management-reality.spec.ts --project=chromium --grep "AI|CommandBar"
          
      - name: ğŸ’¾ Data Persistence Validation
        run: |
          echo "ğŸ’¾ Testing IndexedDB and data flow..."
          npx playwright test tests/event-management-reality.spec.ts --project=chromium --grep "IndexedDB"

  security-scan:
    name: ğŸ›¡ï¸ Security & Dependencies
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ” Dependency Security Audit
        run: npm audit --audit-level=moderate
        
      - name: ğŸ“Š Bundle Size Analysis
        run: |
          npm install -g pnpm
          pnpm install
          npm run build
          echo "ğŸ“¦ Build completed - analyzing bundle size..."

  foundation-compliance-report:
    name: ğŸ“‹ Foundation Compliance Report  
    runs-on: ubuntu-latest
    needs: [foundation-protection, feature-validation]
    if: always()
    
    steps:
      - name: ğŸ“Š Generate Compliance Report
        run: |
          echo "ğŸ”’ FOUNDATION PROTECTION RESULTS:"
          echo "âœ… Foundation tests: ${{ needs.foundation-protection.result }}"
          echo "âœ… Feature validation: ${{ needs.feature-validation.result }}"
          echo ""
          echo "ğŸ“‹ COMPLIANCE STATUS:"
          if [ "${{ needs.foundation-protection.result }}" = "success" ] && [ "${{ needs.feature-validation.result }}" = "success" ]; then
            echo "ğŸ‰ ALL CHECKS PASSED - PR APPROVED FOR CODERABBIT REVIEW"
          else
            echo "âŒ COMPLIANCE FAILED - FIX ISSUES BEFORE CODERABBIT REVIEW"
          fi
          
      - name: ğŸ“ Post Compliance Comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const report = `
            ## ğŸ”’ Foundation Protection Report
            
            **Foundation Tests**: ${{ needs.foundation-protection.result }}
            **Feature Validation**: ${{ needs.feature-validation.result }}
            
            ${needs.foundation-protection.result === 'success' && needs.feature-validation.result === 'success' 
              ? 'âœ… **ALL CHECKS PASSED** - Ready for CodeRabbit review!' 
              : 'âŒ **COMPLIANCE FAILED** - Please fix issues before CodeRabbit review'}
            
            ### ğŸ”’ Foundation Compliance Checklist
            - [ ] 12-month horizontal structure preserved
            - [ ] Week day headers intact (top & bottom)  
            - [ ] Month labels maintained (left & right)
            - [ ] "Life is bigger than a week" philosophy preserved
            - [ ] Performance benchmarks maintained (112+ FPS, <100MB memory)
            - [ ] Cross-platform consistency verified
            
            **Ready for CodeRabbit Review**: ${needs.foundation-protection.result === 'success' ? 'âœ…' : 'âŒ'}
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });