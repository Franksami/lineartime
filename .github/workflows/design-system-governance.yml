name: ğŸ›ï¸ Design System Governance

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]
  push:
    branches: [feature/*, develop]
  workflow_dispatch:
    inputs:
      governance_level:
        description: 'Governance validation level'
        required: true
        default: 'standard'
        type: choice
        options:
          - standard
          - comprehensive
          - enterprise

env:
  NODE_VERSION: '18'
  GOVERNANCE_LEVEL: ${{ github.event.inputs.governance_level || 'standard' }}

jobs:
  # Pre-governance validation
  pre-governance:
    name: ğŸ“‹ Pre-Governance Setup
    runs-on: ubuntu-latest
    outputs:
      should-run-governance: ${{ steps.check-changes.outputs.should-run }}
      governance-level: ${{ steps.determine-level.outputs.level }}
      
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
          
      - name: ğŸ” Check Changes
        id: check-changes
        run: |
          # Check if governance-related files changed
          if git diff --name-only HEAD~1 | grep -E "(design-tokens|components|lib/design-system|scripts)" > /dev/null; then
            echo "should-run=true" >> $GITHUB_OUTPUT
          else
            echo "should-run=false" >> $GITHUB_OUTPUT
          fi
          
      - name: ğŸ¯ Determine Governance Level
        id: determine-level
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]] && [[ "${{ github.base_ref }}" == "main" ]]; then
            echo "level=comprehensive" >> $GITHUB_OUTPUT
          elif [[ "$GOVERNANCE_LEVEL" == "enterprise" ]]; then
            echo "level=enterprise" >> $GITHUB_OUTPUT
          else
            echo "level=standard" >> $GITHUB_OUTPUT
          fi

  # Design Token Governance
  token-governance:
    name: ğŸ¨ Design Token Governance
    runs-on: ubuntu-latest
    needs: pre-governance
    if: needs.pre-governance.outputs.should-run-governance == 'true'
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          
      - name: ğŸ”§ Install Dependencies
        run: |
          npm install -g pnpm
          pnpm install
          
      - name: ğŸ¨ Token Validation
        run: |
          echo "ğŸ” Validating design tokens..."
          npm run tokens:validate
          
      - name: ğŸ§® Token Coverage Analysis
        run: |
          echo "ğŸ“Š Analyzing token coverage..."
          node scripts/token-coverage-analysis.js
          
      - name: ğŸ¯ Hardcoded Value Detection
        run: |
          echo "ğŸ•µï¸ Detecting hardcoded design values..."
          npm run ci:guard
          
      - name: ğŸ“ˆ Token Usage Report
        run: |
          echo "ğŸ“‹ Generating token usage report..."
          node scripts/generate-token-report.js
          
      - name: ğŸ’¾ Upload Token Report
        uses: actions/upload-artifact@v4
        with:
          name: token-governance-report
          path: reports/token-*.json
          retention-days: 30

  # Accessibility Governance
  accessibility-governance:
    name: â™¿ Accessibility Governance
    runs-on: ubuntu-latest
    needs: pre-governance
    if: needs.pre-governance.outputs.should-run-governance == 'true'
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          
      - name: ğŸ”§ Install Dependencies
        run: |
          npm install -g pnpm
          pnpm install
          
      - name: â™¿ Accessibility Compliance Check
        run: |
          echo "ğŸ” Running accessibility governance..."
          node scripts/accessibility-check.js
          
      - name: ğŸŒˆ Contrast Ratio Validation
        run: |
          echo "ğŸ¨ Validating color contrast ratios..."
          npx playwright test tests/accessibility-aaa-compliance.spec.ts --project=chromium
          
      - name: âŒ¨ï¸ Keyboard Navigation Test
        run: |
          echo "âŒ¨ï¸ Testing keyboard navigation..."
          npx playwright test tests/accessibility-compliance.spec.ts --project=chromium --grep "keyboard"
          
      - name: ğŸ“± Screen Reader Compatibility
        run: |
          echo "ğŸ“¢ Validating screen reader compatibility..."
          npx playwright test tests/accessibility-aaa-compliance.spec.ts --project=chromium --grep "aria"
          
      - name: ğŸ“Š Accessibility Report
        if: always()
        run: |
          echo "ğŸ“‹ Generating accessibility report..."
          node scripts/generate-accessibility-report.js

  # Performance Governance
  performance-governance:
    name: âš¡ Performance Governance
    runs-on: ubuntu-latest
    needs: pre-governance
    if: needs.pre-governance.outputs.should-run-governance == 'true'
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          
      - name: ğŸ”§ Install Dependencies
        run: |
          npm install -g pnpm
          pnpm install
          
      - name: ğŸ—ï¸ Build with Analysis
        run: |
          echo "ğŸ”¨ Building with bundle analysis..."
          npm run build:analyze
          
      - name: âš¡ Performance Budget Check
        run: |
          echo "ğŸ’° Checking performance budgets..."
          node scripts/performance-check.js
          
      - name: ğŸ“Š Core Web Vitals Validation
        run: |
          echo "ğŸ¯ Validating Core Web Vitals..."
          npx playwright test tests/performance-improved.spec.ts --project=chromium
          
      - name: ğŸ§  Memory Usage Analysis
        run: |
          echo "ğŸ§  Analyzing memory usage..."
          npx playwright test tests/performance-improved.spec.ts --project=chromium --grep "memory"
          
      - name: ğŸ“ˆ Performance Report
        if: always()
        run: |
          echo "ğŸ“‹ Generating performance report..."
          node scripts/generate-performance-report.js

  # Motion System Governance
  motion-governance:
    name: ğŸ¬ Motion System Governance
    runs-on: ubuntu-latest
    needs: pre-governance
    if: needs.pre-governance.outputs.should-run-governance == 'true'
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          
      - name: ğŸ”§ Install Dependencies
        run: |
          npm install -g pnpm
          pnpm install
          
      - name: ğŸ¬ Motion System Validation
        run: |
          echo "ğŸ­ Validating motion system..."
          node scripts/motion-check.js
          
      - name: â™¿ Reduced Motion Compliance
        run: |
          echo "âš¡ Testing reduced motion compliance..."
          npx playwright test tests/animation-performance.spec.ts --project=chromium --grep "reduced-motion"
          
      - name: âš¡ Animation Performance
        run: |
          echo "ğŸ“ˆ Testing animation performance..."
          npx playwright test tests/animation-performance.spec.ts --project=chromium
          
      - name: ğŸŒ€ Vestibular Safety Check
        run: |
          echo "ğŸ¥ Checking vestibular safety..."
          node scripts/vestibular-safety-check.js

  # i18n Governance
  i18n-governance:
    name: ğŸŒ i18n Governance
    runs-on: ubuntu-latest
    needs: pre-governance
    if: needs.pre-governance.outputs.should-run-governance == 'true'
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          
      - name: ğŸ”§ Install Dependencies
        run: |
          npm install -g pnpm
          pnpm install
          
      - name: ğŸŒ i18n Completeness Check
        run: |
          echo "ğŸ“ Checking i18n completeness..."
          node scripts/i18n-check.js
          
      - name: â†”ï¸ RTL Layout Validation
        run: |
          echo "ğŸ“ Validating RTL layouts..."
          npx playwright test tests/rtl-layout-support.spec.ts --project=chromium
          
      - name: ğŸ“… Locale-aware Formatting
        run: |
          echo "ğŸ”¢ Testing locale-aware formatting..."
          node scripts/locale-formatting-check.js
          
      - name: ğŸ—‚ï¸ Translation Key Validation
        run: |
          echo "ğŸ”‘ Validating translation keys..."
          node scripts/translation-key-check.js

  # Comprehensive Quality Assessment
  quality-assessment:
    name: ğŸ“Š Quality Assessment
    runs-on: ubuntu-latest
    needs: [token-governance, accessibility-governance, performance-governance, motion-governance, i18n-governance]
    if: always() && needs.pre-governance.outputs.should-run-governance == 'true'
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          
      - name: ğŸ”§ Install Dependencies
        run: |
          npm install -g pnpm
          pnpm install
          
      - name: ğŸ“Š Generate Governance Report
        run: |
          echo "ğŸ“‹ Generating comprehensive governance report..."
          node scripts/generate-governance-report.js
          
      - name: ğŸ¯ Calculate Governance Score
        id: governance-score
        run: |
          echo "ğŸ§® Calculating overall governance score..."
          SCORE=$(node scripts/calculate-governance-score.js)
          echo "score=$SCORE" >> $GITHUB_OUTPUT
          echo "ğŸ“Š Governance Score: $SCORE%"
          
      - name: ğŸš¨ Quality Gate Enforcement
        run: |
          echo "ğŸš¦ Enforcing quality gates..."
          SCORE="${{ steps.governance-score.outputs.score }}"
          LEVEL="${{ needs.pre-governance.outputs.governance-level }}"
          
          case $LEVEL in
            "standard")
              THRESHOLD=75
              ;;
            "comprehensive")
              THRESHOLD=85
              ;;
            "enterprise")
              THRESHOLD=90
              ;;
          esac
          
          echo "Required threshold for $LEVEL: $THRESHOLD%"
          echo "Actual score: $SCORE%"
          
          if [ "$SCORE" -lt "$THRESHOLD" ]; then
            echo "âŒ Quality gate failed! Score $SCORE% is below required $THRESHOLD%"
            exit 1
          else
            echo "âœ… Quality gate passed! Score $SCORE% meets $LEVEL requirements"
          fi
          
      - name: ğŸ’¾ Upload Governance Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: governance-reports
          path: |
            reports/governance-*.json
            reports/quality-*.html
          retention-days: 30

  # Security Governance
  security-governance:
    name: ğŸ›¡ï¸ Security Governance
    runs-on: ubuntu-latest
    needs: pre-governance
    if: needs.pre-governance.outputs.should-run-governance == 'true'
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ›¡ï¸ Dependency Security Audit
        run: |
          echo "ğŸ” Running security audit..."
          npm audit --audit-level=moderate
          
      - name: ğŸ•µï¸ Vulnerability Scanning
        uses: github/codeql-action/analyze@v2
        with:
          languages: javascript,typescript
          
      - name: ğŸ” Secrets Detection
        run: |
          echo "ğŸ” Scanning for exposed secrets..."
          # This would typically use a tool like truffleHog or git-secrets
          git log --oneline -100 | grep -i -E "(password|secret|key|token)" || echo "No obvious secrets found"

  # Rollback Management
  rollback-management:
    name: ğŸ”„ Rollback Management
    runs-on: ubuntu-latest
    needs: [quality-assessment]
    if: failure() && github.event_name == 'pull_request'
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸš¨ Quality Gate Failure Notification
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `
            ## ğŸš¨ Governance Quality Gates Failed
            
            The design system governance checks have failed. This PR cannot be merged until all quality gates pass.
            
            ### ğŸ” What to check:
            - Review the failed jobs above for specific issues
            - Check the governance dashboard at /governance-dashboard
            - Ensure all design tokens are properly used
            - Verify accessibility compliance (WCAG AAA)
            - Check performance budgets and Core Web Vitals
            - Validate motion system compliance
            - Ensure i18n completeness
            
            ### ğŸ› ï¸ How to fix:
            1. Run governance checks locally: \`npm run governance:check\`
            2. Fix identified issues
            3. Re-run tests: \`npm run test:all\`
            4. Push your fixes
            
            ### ğŸ“Š Governance Dashboard
            View detailed metrics at: [Governance Dashboard](/governance-dashboard)
            
            _This comment will be updated when you push new commits._
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
            
      - name: ğŸ·ï¸ Add Quality Gate Label
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['governance:failed', 'needs-fixes']
            });

  # Success Notification
  governance-success:
    name: âœ… Governance Success
    runs-on: ubuntu-latest
    needs: [quality-assessment, security-governance]
    if: success()
    
    steps:
      - name: ğŸ‰ Success Notification
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            const comment = `
            ## âœ… Design System Governance Passed!
            
            All governance quality gates have passed successfully. This PR meets the design system standards.
            
            ### ğŸ“Š Quality Metrics:
            - ğŸ¨ Design Tokens: âœ… Validated
            - â™¿ Accessibility: âœ… WCAG AAA Compliant
            - âš¡ Performance: âœ… Within Budgets
            - ğŸ¬ Motion System: âœ… Compliant
            - ğŸŒ i18n: âœ… Complete
            - ğŸ›¡ï¸ Security: âœ… Secure
            
            ### ğŸ“ˆ View Reports:
            - [Governance Dashboard](/governance-dashboard)
            - Check workflow artifacts for detailed reports
            
            _Ready for code review and merge!_
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
            
      - name: ğŸ·ï¸ Add Success Labels
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            // Remove failure labels if they exist
            try {
              await github.rest.issues.removeLabel({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: 'governance:failed'
              });
            } catch (e) {
              // Label might not exist
            }
            
            try {
              await github.rest.issues.removeLabel({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: 'needs-fixes'
              });
            } catch (e) {
              // Label might not exist
            }
            
            // Add success label
            github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['governance:passed', 'ready-for-review']
            });